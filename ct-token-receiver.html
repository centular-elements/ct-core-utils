<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="ct-user-identity.html">

<dom-module id="ct-token-receiver">
    <template>

        <iron-localstorage
           id="tokenStorage"
           name="user-token"
           use-raw
           auto-save-disabled
        ></iron-localstorage>

        <app-location route="{{ route }}"></app-location>
        <app-route route="[[ route ]]" pattern="[[ _redirectPattern ]]" tail="{{ routeData }}"></app-route>

        <ct-user-identity id="identity"></ct-user-identity>
    </template>

    <script>
        Polymer({
            is: 'ct-token-receiver',

            properties: {
                /**
                 * Token redirect uri you've registered for this client
                 */
                tokenRedirectUri: String
            },

            observers: [
                '_setRoutePattern(tokenRedirectUri)',
                '_routeChanged(routeData)'
            ],

            _setRoutePattern: function() {
                this._redirectPattern = new URL(this.tokenRedirectUri).pathname;
            },

            _routeChanged: function(routeData) {
                if (routeData.prefix !== this._redirectPattern) {
                    return;
                }
                if (routeData.__queryParams.access_token) {
                    this.$.tokenStorage.value = routeData.__queryParams.access_token;
                    this.$.tokenStorage.save();
                    this.$.identity.setToken(routeData.__queryParams.access_token);
                }
            }
        });
    </script>
</dom-module>